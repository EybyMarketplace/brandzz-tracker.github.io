/* Influencer Tracker v2.0.0 | Built: 2025-07-23T17:53:31.585Z */
!function(t,e,a){"use strict";void 0!==t&&(t.InfluencerTrackerBuild={name:"shopify",version:"2.0.0",timestamp:"2025-07-23T17:53:31.596Z",files:["src/core/tracker-core.js","src/adapters/shopify-adapter.js"]}),function(t,e){const a={apiEndpoint:"",projectId:"",enableConsentCheck:!0,batchSize:10,batchTimeout:3e3,sessionTimeout:18e5,version:"2.0.0"},r={checkConsent:function(){return!a.enableConsentCheck||"granted"===localStorage.getItem("analytics_consent")},waitForConsent:function(t){const e=setInterval(()=>{this.checkConsent()&&(clearInterval(e),t())},500);setTimeout(()=>{clearInterval(e)},1e4)}},i={generateUUID:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){const e=16*Math.random()|0;return("x"==t?e:3&e|8).toString(16)})},getUserId:function(){let t=localStorage.getItem("inf_user_id");return t||(t=this.generateUUID(),localStorage.setItem("inf_user_id",t)),t},getSessionId:function(){let t=sessionStorage.getItem("inf_session");if(t){const e=JSON.parse(t),r=Date.now();if(r-e.lastActivity<a.sessionTimeout)return e.lastActivity=r,sessionStorage.setItem("inf_session",JSON.stringify(e)),e.id}const e={id:this.generateUUID(),startTime:Date.now(),lastActivity:Date.now()};return sessionStorage.setItem("inf_session",JSON.stringify(e)),e.id}},n={detectInfluencer:function(){const a=new URLSearchParams(t.location.search),r=new URLSearchParams(t.location.hash.substring(1)),i={influencer_id:a.get("inf_id")||a.get("influencer")||r.get("inf_id"),campaign_id:a.get("camp_id")||a.get("campaign")||r.get("camp_id"),promo_code:a.get("promo")||a.get("codigo")||r.get("promo"),utm_source:a.get("utm_source"),utm_medium:a.get("utm_medium"),utm_campaign:a.get("utm_campaign"),ref:a.get("ref")},n=e.referrer;let o=null;if(n.includes("instagram.com")?o="instagram":n.includes("tiktok.com")?o="tiktok":n.includes("youtube.com")||n.includes("youtu.be")?o="youtube":n.includes("facebook.com")?o="facebook":(n.includes("twitter.com")||n.includes("x.com"))&&(o="twitter"),Object.values(i).some(t=>null!==t)||o){const e={...i,social_source:o,detected_at:Date.now(),landing_page:t.location.href};return sessionStorage.setItem("inf_attribution",JSON.stringify(e)),e}const c=sessionStorage.getItem("inf_attribution");return c?JSON.parse(c):null}},o={generate:function(){const e=t.screen,a=navigator;return{user_agent:a.userAgent,language:a.language,platform:a.platform,screen_resolution:`${e.width}x${e.height}`,color_depth:e.colorDepth,timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,device_memory:a.deviceMemory||null,hardware_concurrency:a.hardwareConcurrency||null,connection:a.connection?{effective_type:a.connection.effectiveType,downlink:a.connection.downlink}:null}}},c={queue:[],add:function(t){this.queue.push(t),this.queue.length>=a.batchSize&&this.flush()},flush:function(){if(0===this.queue.length||!a.apiEndpoint)return;const t=this.queue.splice(0,a.batchSize);fetch(a.apiEndpoint,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({project_id:a.projectId,events:t,version:a.version})}).catch(e=>{console.warn("Influencer Tracker: Failed to send events",e);const a=JSON.parse(localStorage.getItem("inf_failed_events")||"[]");a.push(...t),localStorage.setItem("inf_failed_events",JSON.stringify(a.slice(-100)))})},scheduleFlush:function(){this.flushTimer&&clearTimeout(this.flushTimer),this.flushTimer=setTimeout(()=>this.flush(),a.batchTimeout)}},InfluencerTracker={initialized:!1,startTime:Date.now(),platform:"generic",adapter:null,init:function(t={}){this.initialized||(Object.assign(a,t),a.apiEndpoint?(this.platform=this.detectPlatform(),console.log(`🎯 Plataforma detectada: ${this.platform}`),this.adapter=this.loadAdapter(this.platform),!a.enableConsentCheck||r.checkConsent()?this.startTracking():r.waitForConsent(()=>this.startTracking())):console.warn("Influencer Tracker: apiEndpoint não configurado"))},detectPlatform:function(){return t.Shopify||t.shopifyData||e.querySelector('meta[name="shopify-checkout-api-token"]')?"shopify":"generic"},loadAdapter:function(e){return t[`${e}Adapter`]||null},startTracking:function(){this.initialized=!0;const a=n.detectInfluencer();this.track("page_view",{page_url:t.location.href,page_title:e.title,referrer:e.referrer,influencer_data:a}),this.setupUniversalTracking(),this.adapter?.init&&this.adapter.init(),c.scheduleFlush(),t.addEventListener("beforeunload",()=>c.flush()),console.log("Influencer Tracker: Inicializado com sucesso")},track:function(e,a={}){if(!this.initialized)return;const r={event_id:i.generateUUID(),event_type:e,timestamp:Date.now(),user_id:i.getUserId(),session_id:i.getSessionId(),page_url:t.location.href,device_fingerprint:o.generate(),platform:this.platform,properties:a};this.adapter?.enrichEvent&&Object.assign(r.properties,this.adapter.enrichEvent(e,a)),c.add(r)},setupUniversalTracking:function(){let a=0;t.addEventListener("scroll",this.throttle(()=>{const r=Math.round(t.scrollY/(e.body.scrollHeight-t.innerHeight)*100);r>a&&(a=r,[25,50,75,90].includes(r)&&this.track("scroll_milestone",{scroll_percent:r}))},1e3)),e.addEventListener("click",t=>{const e=t.target,a={element_tag:e.tagName,element_classes:e.className,element_id:e.id,element_text:e.textContent?.substring(0,100),x:t.clientX,y:t.clientY};this.track("click",a)}),e.addEventListener("submit",t=>{const e=t.target;this.track("form_submit",{form_id:e.id,form_classes:e.className,form_action:e.action,field_count:e.elements.length})});let r=0;setInterval(()=>{r+=10,[30,60,120,300].includes(r)&&this.track("time_milestone",{seconds_on_page:r})},1e4),this.setupExitTracking()},setupExitTracking:function(){let a=!1;e.addEventListener("mouseleave",r=>{r.clientY<=0&&!a&&(a=!0,this.track("exit_intent",{time_on_page:Date.now()-this.startTime,scroll_percent:Math.round(t.scrollY/(e.body.scrollHeight-t.innerHeight)*100)}))})},trackPurchase:function(t){this.track("purchase",{order_id:t.orderId,total_value:t.totalValue,currency:t.currency||"BRL",items:t.items,coupon_code:t.couponCode,influencer_attribution:JSON.parse(sessionStorage.getItem("inf_attribution")||"null")})},trackCustomEvent:function(t,e){this.track(t,e)},throttle:function(t,e){let a;return function(){const r=arguments;a||(t.apply(this,r),a=!0,setTimeout(()=>a=!1,e))}}};t.InfluencerTracker=InfluencerTracker,t.InfluencerTracker.ConsentManager=r,t.InfluencerTracker.IdGenerator=i,t.InfluencerTracker.InfluencerDetector=n,t.InfluencerTracker.DeviceFingerprint=o,t.InfluencerTracker.EventQueue=c}(t,e),function(t,e){t.shopifyAdapter={lastCartState:null,cartUpdateTimeout:null,init:function(){console.log("🛍️ Inicializando adaptador Shopify"),this.setupShopifyTracking(),this.setupCartTracking(),this.setupProductTracking(),this.setupCheckoutTracking(),this.lastCartState={items:this.getCartItemCount(),value:this.getCartValue()},console.log("🛒 Estado inicial do carrinho:",this.lastCartState)},enrichEvent:function(e,a){const r={shop_domain:t.Shopify?.shop||t.shopifyData?.shop?.domain,currency:t.shopifyData?.shop?.currency||"USD",customer_id:t.shopifyData?.customer?.id,cart_token:this.getCartToken()};return"cart_update"===e&&(r.cart_items=this.getCartItemCount(),r.cart_value=this.getCartValue()),"product_view"===e&&t.shopifyData?.product&&(r.product_id=t.shopifyData.product.id,r.product_handle=t.shopifyData.product.handle,r.product_type=t.shopifyData.product.type,r.product_vendor=t.shopifyData.product.vendor,r.product_price=t.shopifyData.product.price,r.product_available=t.shopifyData.product.available),r},getCartValue:function(){if(console.log("🛒 getCartValue (Shopify)"),t.shopifyData?.cart?.total_price!==a){const e=t.shopifyData.cart.total_price;return console.log("   ✅ Via Shopify data:",e),e}try{const t=new XMLHttpRequest;if(t.open("GET","/cart.js",!1),t.send(),200===t.status){const e=JSON.parse(t.responseText).total_price/100;return console.log("   ✅ Via API /cart.js:",e),e}}catch(t){console.log("   ❌ Erro API:",t)}const r=["[data-cart-total]",".cart-total","#cart-total",".basket-total",".cart__total",".drawer-cart__total"];for(const t of r){const a=e.querySelector(t);if(a){const t=a.textContent||a.value||a.getAttribute("data-cart-total");if(t){const e=this.parseCartValue(t);if(null!==e)return console.log("   ✅ Via DOM:",e),e}}}return console.log("   ⚠️ Fallback para 0"),0},getCartItemCount:function(){if(t.shopifyData?.cart?.item_count!==a)return t.shopifyData.cart.item_count;try{const t=new XMLHttpRequest;if(t.open("GET","/cart.js",!1),t.send(),200===t.status)return JSON.parse(t.responseText).item_count}catch(t){console.log("Erro ao buscar item count:",t)}return e.querySelectorAll("[data-cart-item], .cart-item, .line-item").length},getCartToken:function(){try{const t=new XMLHttpRequest;if(t.open("GET","/cart.js",!1),t.send(),200===t.status)return JSON.parse(t.responseText).token}catch(t){return null}},parseCartValue:function(t){if(!t)return null;let e=(t=String(t).trim()).replace(/[^\d.,\-]/g,"");if(e.includes(",")&&e.includes("."))e=e.lastIndexOf(",")>e.lastIndexOf(".")?e.replace(/\./g,"").replace(",","."):e.replace(/,/g,"");else if(e.includes(",")){const t=e.split(",");e=2===t.length&&t[1].length<=2?e.replace(",","."):e.replace(/,/g,"")}const a=parseFloat(e);return a>1e4?a/100:isNaN(a)?null:a},setupShopifyTracking:function(){const a=t.InfluencerTracker;"product"===t.shopifyData?.page?.type&&a.trackCustomEvent("product_view",{product_id:t.shopifyData.product?.id,product_handle:t.shopifyData.product?.handle,product_title:t.shopifyData.product?.title,product_price:t.shopifyData.product?.price,product_type:t.shopifyData.product?.type,product_vendor:t.shopifyData.product?.vendor,product_available:t.shopifyData.product?.available,variants_count:t.shopifyData.product?.variants?.length}),"collection"===t.shopifyData?.page?.type&&a.trackCustomEvent("collection_view",{collection_id:t.shopifyData.collection?.id,collection_handle:t.shopifyData.collection?.handle,collection_title:t.shopifyData.collection?.title,products_count:t.shopifyData.collection?.products_count}),"cart"===t.shopifyData?.page?.type&&a.trackCustomEvent("cart_view",{cart_items:t.shopifyData.cart?.item_count||0,cart_total:t.shopifyData.cart?.total_price||0,cart_items_detail:t.shopifyData.cart?.items||[]}),e.addEventListener("submit",e=>{const r=e.target;if(r.matches('[action*="/cart/add"], .product-form, form[action*="cart"]')){const e=new FormData(r),i=e.get("id")||e.get("variant_id"),n=e.get("quantity")||1;a.trackCustomEvent("add_to_cart_attempt",{product_id:t.shopifyData?.product?.id,variant_id:i,quantity:parseInt(n),product_handle:t.shopifyData?.product?.handle,product_title:t.shopifyData?.product?.title,form_action:r.action,trigger_element:"form_submit"}),setTimeout(()=>{this.checkCartChange("add_to_cart")},1500)}}),e.addEventListener("click",e=>{const r=e.target;if(r.matches('.btn-add-to-cart, [data-add-to-cart], .product-form__cart-submit, .btn[type="submit"]')){const e=r.closest("form");e&&e.matches('[action*="/cart/add"]')&&a.trackCustomEvent("add_to_cart_click",{product_id:t.shopifyData?.product?.id,button_text:r.textContent?.trim(),button_classes:r.className,trigger_element:"button_click"})}if(r.matches(".qty-btn, .cart-item__quantity-btn, [data-quantity-change]")){const t=r.getAttribute("data-action")||(r.textContent.includes("+")?"increase":"decrease");a.trackCustomEvent("shopify_cart_quantity_change",{action:t,trigger_element:"quantity_button"}),setTimeout(()=>{this.checkCartChange("quantity_change")},1e3)}r.matches(".cart-remove, [data-cart-remove], .cart-item__remove")&&(a.trackCustomEvent("shopify_cart_remove_attempt",{trigger_element:"remove_button"}),setTimeout(()=>{this.checkCartChange("remove_item")},1e3))})},setupCartTracking:function(){const a=t.InfluencerTracker,r=new MutationObserver(t=>{let e=!1;t.forEach(t=>{"childList"===t.type&&[...t.addedNodes,...t.removedNodes].some(t=>{if(t.nodeType!==Node.ELEMENT_NODE)return!1;const e=t;return e.matches?.("[data-cart-item], .cart-item, .line-item, .cart__item")||e.querySelector?.("[data-cart-item], .cart-item, .line-item, .cart__item")||e.classList?.contains("cart-item")||null!==e.getAttribute?.("data-cart-item")})&&(e=!0),"attributes"===t.type&&["data-cart-item","data-quantity","data-price","data-cart-total"].includes(t.attributeName)&&(e=!0)}),e&&this.checkCartChange("dom_mutation")}),i=["[data-cart-container]",".cart-drawer",".mini-cart",".cart-items",".drawer-cart","#cart-drawer",".cart",".cart-form"];let n=null;for(const t of i)if(n=e.querySelector(t),n){console.log("🎯 Cart container encontrado:",t);break}n||(n=e.body,console.log("⚠️ Usando body como fallback para cart observer")),r.observe(n,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["data-cart-item","data-quantity","data-price","data-cart-total","class"]}),e.addEventListener("change",t=>{t.target.matches('input[name*="quantity"], .cart-quantity, .qty-input, input[data-quantity-item]')&&(a.trackCustomEvent("shopify_cart_quantity_input_change",{new_quantity:t.target.value,trigger_element:"quantity_input"}),setTimeout(()=>{this.checkCartChange("quantity_input")},500))})},setupProductTracking:function(){const a=t.InfluencerTracker,r=new IntersectionObserver(t=>{t.forEach(t=>{if(t.isIntersecting){const e=t.target;a.trackCustomEvent("product_impression",{product_id:e.getAttribute("data-product-id"),product_handle:e.getAttribute("data-product-handle"),product_title:e.getAttribute("data-product-title"),product_price:e.getAttribute("data-product-price"),visibility_percent:Math.round(100*t.intersectionRatio),element_position:this.getElementPosition(e)})}})},{threshold:.5});["[data-product-id]",".product-item",".product-card",".grid-product",".product-grid-item"].forEach(t=>{e.querySelectorAll(t).forEach(t=>{r.observe(t)})}),e.addEventListener("click",t=>{const e=t.target,r=e.closest("[data-product-id], .product-item, .product-card");r&&a.trackCustomEvent("product_click",{product_id:r.getAttribute("data-product-id"),product_handle:r.getAttribute("data-product-handle"),product_title:r.getAttribute("data-product-title"),click_element:e.tagName,click_text:e.textContent?.substring(0,50)})}),e.addEventListener("change",e=>{if(e.target.matches('select[name="id"], input[name="id"], .product-form__variants select')){const r=e.target.value;a.trackCustomEvent("variant_selection",{product_id:t.shopifyData?.product?.id,variant_id:r,selection_method:e.target.tagName.toLowerCase()})}})},setupCheckoutTracking:function(){const a=t.InfluencerTracker;e.addEventListener("click",t=>{const e=t.target;e.matches('.btn-checkout, [data-checkout], .checkout-button, [href*="/checkout"]')&&a.trackCustomEvent("checkout_initiated",{cart_items:this.getCartItemCount(),cart_value:this.getCartValue(),checkout_method:"A"===e.tagName?"link":"button",button_text:e.textContent?.trim()})}),t.location.pathname.includes("/checkout")&&(a.trackCustomEvent("checkout_page_view",{checkout_step:this.getCheckoutStep(),cart_items:this.getCartItemCount(),cart_value:this.getCartValue()}),this.setupCheckoutStepTracking()),(t.location.pathname.includes("/thank_you")||t.location.pathname.includes("/orders/"))&&this.trackPurchaseCompletion()},setupCheckoutStepTracking:function(){const a=t.InfluencerTracker,r=new MutationObserver(()=>{const t=this.getCheckoutStep();this.lastCheckoutStep!==t&&(a.trackCustomEvent("shopify_checkout_step_change",{previous_step:this.lastCheckoutStep,current_step:t,cart_items:this.getCartItemCount(),cart_value:this.getCartValue()}),this.lastCheckoutStep=t)}),i=e.querySelector(".checkout, #checkout, .main-content")||e.body;r.observe(i,{childList:!0,subtree:!0})},checkCartChange:function(e){this.cartUpdateTimeout&&clearTimeout(this.cartUpdateTimeout),this.cartUpdateTimeout=setTimeout(()=>{const a={items:this.getCartItemCount(),value:this.getCartValue()};(!this.lastCartState||a.items!==this.lastCartState.items||Math.abs(a.value-this.lastCartState.value)>.01)&&(console.log("🛒 Cart mudou:",this.lastCartState,"→",a),t.InfluencerTracker.track("cart_update",{cart_items:a.items,cart_value:a.value,previous_items:this.lastCartState?.items||0,previous_value:this.lastCartState?.value||0,change_trigger:e,change_type:a.items>(this.lastCartState?.items||0)?"add":a.items<(this.lastCartState?.items||0)?"remove":"update"}),this.lastCartState=a)},1e3)},getCheckoutStep:function(){return e.querySelector('.step-contact, [data-step="contact"]')?"contact":e.querySelector('.step-shipping, [data-step="shipping"]')?"shipping":e.querySelector('.step-payment, [data-step="payment"]')?"payment":e.querySelector('.step-review, [data-step="review"]')?"review":"unknown"},getElementPosition:function(t){const e=t.getBoundingClientRect();return{x:e.left,y:e.top,width:e.width,height:e.height}},trackPurchaseCompletion:function(){const e=t.InfluencerTracker,a=this.extractOrderData();e.trackCustomEvent("purchase_completed",{...a,influencer_attribution:JSON.parse(sessionStorage.getItem("inf_attribution")||"null"),page_url:t.location.href}),a.order_id&&e.trackPurchase({orderId:a.order_id,totalValue:a.total_value,currency:a.currency,items:a.items,couponCode:a.coupon_code})},extractOrderData:function(){if(t.Shopify?.checkout)return{order_id:t.Shopify.checkout.order_id,total_value:t.Shopify.checkout.total_price/100,currency:t.Shopify.checkout.currency,items:t.Shopify.checkout.line_items,coupon_code:t.Shopify.checkout.discount?.code};const a=e.querySelector(".order-number, [data-order-number]")?.textContent,r=e.querySelector(".total-price, [data-total-price]");return{order_id:a,total_value:r?this.parseCartValue(r.textContent):0,currency:"USD",items:[],coupon_code:null}}}}(t,e)}("undefined"!=typeof window?window:this,"undefined"!=typeof document?document:{});